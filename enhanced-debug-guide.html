<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强错误处理 - 标签同步调试指南</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .update-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        .error-box {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        .step-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .feature-list {
            margin: 20px 0;
        }
        .feature-list li {
            margin: 8px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #17a2b8;
        }
        .success-list li {
            border-left-color: #28a745;
        }
        .warning-list li {
            border-left-color: #ffc107;
            background: #fff9c4;
        }
        h1 { color: #1f2937; margin-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; margin-bottom: 15px; }
        h3 { color: #4b5563; margin-top: 25px; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 增强错误处理 - 标签同步调试指南</h1>
        
        <div class="update-box">
            <h2>✅ 最新更新</h2>
            <p>我已经大幅增强了标签同步的错误处理机制，现在可以获取更详细的错误信息来帮助排查问题。</p>
        </div>
        
        <div class="error-box">
            <h2>❌ 当前问题</h2>
            <p>您报告的错误信息：</p>
            <div class="code-block">
📋 当前标签列表: Array(3)
❤️ 同步标签失败: r
            </div>
            <p>错误信息"r"过于简短，无法确定具体问题。现在增强的错误处理会提供完整的错误信息。</p>
        </div>
        
        <h2>🛠️ 增强的错误处理</h2>
        
        <h3>1. 强制同步错误处理</h3>
        <ul class="feature-list success-list">
            <li>显示完整的错误对象信息</li>
            <li>输出错误名称、消息、堆栈跟踪</li>
            <li>提供多种错误字符串表示</li>
            <li>帮助精确定位问题原因</li>
        </ul>
        
        <h3>2. 标签同步过程细化</h3>
        <ul class="feature-list success-list">
            <li>每个步骤都有独立的错误处理</li>
            <li>创建新标签失败时的回退机制</li>
            <li>更新计数失败时的详细日志</li>
            <li>数据库事务错误的精确捕获</li>
        </ul>
        
        <h2>🚀 测试步骤</h2>
        
        <div class="step-box">
            <h3>步骤 1: 重新加载扩展</h3>
            <ul class="feature-list">
                <li>在Chrome中打开 <code>chrome://extensions/</code></li>
                <li>找到QuickMagnet扩展并点击刷新按钮</li>
                <li>确认扩展版本已更新（修改时间最新）</li>
            </ul>
        </div>
        
        <div class="step-box">
            <h3>步骤 2: 打开开发者工具</h3>
            <ul class="feature-list">
                <li>右键点击扩展图标</li>
                <li>选择"检查弹出内容"</li>
                <li>切换到Console面板</li>
                <li>确保看到所有日志级别（包括error和warn）</li>
            </ul>
        </div>
        
        <div class="step-box">
            <h3>步骤 3: 触发标签同步</h3>
            <ul class="feature-list">
                <li>打开QuickMagnet扩展面板</li>
                <li>切换到标签视图（点击标签图标）</li>
                <li>如果显示"还没有标签"，点击"🔄 强制同步"按钮</li>
                <li>仔细观察控制台的详细输出</li>
            </ul>
        </div>
        
        <h2>📊 预期的详细输出</h2>
        
        <p>现在控制台会显示非常详细的调试信息：</p>
        
        <div class="code-block">
🔄 开始强制同步标签...
🔄 开始同步所有标签...
📊 总共 X 条收藏
📝 收藏 "xxx" 的标签: ["标签1", "标签2"]
🏷️ 发现 X 条收藏包含标签
📊 所有使用的标签: ["标签1", "标签2"]
💾 数据库中已存在的标签: [...]
🆕 需要创建的新标签: [...]
🔄 开始创建新标签...
✅ 新标签创建完成: [...]
🔄 开始更新所有标签计数...
📋 当前标签列表: [...]
🏷️ 标签 "xxx" 当前计数: 0, 实际计数: 1
✅ 已更新标签 "xxx" 计数: 0 -> 1
✅ 标签计数更新完成
✅ 所有标签计数更新完成
✅ 同步标签完成: 新增 X 个标签, 总共 X 个标签
        </div>
        
        <h2>🐛 如果出现错误</h2>
        
        <p>现在错误信息会非常详细：</p>
        
        <div class="code-block">
❤️ 强制同步失败 - 详细错误信息:
错误对象: {Error object}
错误名称: TypeError
错误消息: Cannot read properties of undefined...
错误堆栈: Error: ... at function_name (file:line:col)
错误字符串: TypeError: Cannot read properties...
        </div>
        
        <h3>常见错误类型分析</h3>
        
        <ul class="feature-list warning-list">
            <li><strong>TypeError</strong> - 通常是对象属性访问错误或方法不存在</li>
            <li><strong>DataError</strong> - Dexie数据库操作错误，如约束违反</li>
            <li><strong>TransactionInactiveError</strong> - 数据库事务已失效</li>
            <li><strong>InvalidStateError</strong> - 数据库连接状态错误</li>
            <li><strong>QuotaExceededError</strong> - 存储空间不足</li>
        </ul>
        
        <h2>🔍 逐步排查方法</h2>
        
        <div class="step-box">
            <h3>如果创建新标签失败</h3>
            <ul class="feature-list">
                <li>检查是否有重复的标签名称</li>
                <li>验证标签对象格式是否正确</li>
                <li>确认数据库连接状态</li>
                <li>查看是否是存储空间问题</li>
            </ul>
        </div>
        
        <div class="step-box">
            <h3>如果更新计数失败</h3>
            <ul class="feature-list">
                <li>检查标签ID是否存在</li>
                <li>验证数据库事务是否正常</li>
                <li>确认更新操作的权限</li>
                <li>查看是否有并发操作冲突</li>
            </ul>
        </div>
        
        <h2>📝 需要提供的信息</h2>
        
        <p>请在测试后提供以下信息：</p>
        
        <ul class="feature-list">
            <li>完整的控制台输出（从开始同步到结束）</li>
            <li>具体的错误名称和错误消息</li>
            <li>错误堆栈跟踪信息</li>
            <li>扩展是否正常工作的其他功能</li>
            <li>浏览器版本和操作系统信息</li>
        </ul>
        
        <div class="update-box">
            <h3>✨ 优化点</h3>
            <ul>
                <li>所有异步操作都包含在try-catch块中</li>
                <li>每个操作步骤都有独立的错误处理</li>
                <li>提供了数据库操作的回退机制</li>
                <li>增加了事务级别的错误捕获</li>
                <li>输出格式化的错误信息便于分析</li>
            </ul>
        </div>
        
        <p style="text-align: center; margin-top: 30px; color: #666;">
            现在可以重新测试标签同步功能，详细的错误信息将帮助我们快速定位和解决问题 🔍
        </p>
    </div>
</body>
</html>